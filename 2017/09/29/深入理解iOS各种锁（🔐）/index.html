<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰ | Aeron_Xie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ğŸ”é¡¾åæ€ä¹‰ã€‚ã€‚é”ä¸Šäº†è¡¨ç¤ºå°±è¿›ä¸æ¥ï¼Œè§£é”åä½ æ‰å¯ä»¥è¿›æ¥ã€‚ã€‚åœ¨å¼€å‘ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåœ¨å¤šçº¿ç¨‹å¼€å‘ä¸­ï¼Œå°±ç»å¸¸ä¼šä½¿ç”¨åˆ°é”æœºåˆ¶ã€‚é”æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­å¯¹èµ„æºçš„è®¿é—®é™åˆ¶ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´æ“ä½œèµ„æº.
ä¸åŒçš„é”çš„æ€§èƒ½ä¸å®ç°ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å°±æ¥ç ”ç©¶ä¸‹åœ¨iOSä¸­çš„å‡ ç§ä¸åŒçš„é”~~">
<meta property="og:type" content="article">
<meta property="og:title" content="æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰">
<meta property="og:url" content="http://yoursite.com/2017/09/29/æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰/index.html">
<meta property="og:site_name" content="Aeron_Xie">
<meta property="og:description" content="ğŸ”é¡¾åæ€ä¹‰ã€‚ã€‚é”ä¸Šäº†è¡¨ç¤ºå°±è¿›ä¸æ¥ï¼Œè§£é”åä½ æ‰å¯ä»¥è¿›æ¥ã€‚ã€‚åœ¨å¼€å‘ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåœ¨å¤šçº¿ç¨‹å¼€å‘ä¸­ï¼Œå°±ç»å¸¸ä¼šä½¿ç”¨åˆ°é”æœºåˆ¶ã€‚é”æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­å¯¹èµ„æºçš„è®¿é—®é™åˆ¶ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´æ“ä½œèµ„æº.
ä¸åŒçš„é”çš„æ€§èƒ½ä¸å®ç°ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å°±æ¥ç ”ç©¶ä¸‹åœ¨iOSä¸­çš„å‡ ç§ä¸åŒçš„é”~~">
<meta property="og:image" content="http://7xoijj.com1.z0.glb.clouddn.com/2017031601.png">
<meta property="og:image" content="http://7xoijj.com1.z0.glb.clouddn.com/5AEA053C-6EED-41CE-A29B-69EB444F2E9D.png">
<meta property="og:updated_time" content="2017-09-29T09:42:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰">
<meta name="twitter:description" content="ğŸ”é¡¾åæ€ä¹‰ã€‚ã€‚é”ä¸Šäº†è¡¨ç¤ºå°±è¿›ä¸æ¥ï¼Œè§£é”åä½ æ‰å¯ä»¥è¿›æ¥ã€‚ã€‚åœ¨å¼€å‘ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåœ¨å¤šçº¿ç¨‹å¼€å‘ä¸­ï¼Œå°±ç»å¸¸ä¼šä½¿ç”¨åˆ°é”æœºåˆ¶ã€‚é”æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­å¯¹èµ„æºçš„è®¿é—®é™åˆ¶ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´æ“ä½œèµ„æº.
ä¸åŒçš„é”çš„æ€§èƒ½ä¸å®ç°ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å°±æ¥ç ”ç©¶ä¸‹åœ¨iOSä¸­çš„å‡ ç§ä¸åŒçš„é”~~">
  
    <link rel="alternative" href="/atom.xml" title="Aeron_Xie" type="application/atom+xml">
  
  
    <link rel="icon" href="img/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/32269?v=3&amp;s=460" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Aeron_Xie</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>èœå•</li>
						<li>æ ‡ç­¾</li>
						
						<li>å‹æƒ…é“¾æ¥</li>
						
						
						<li>å…³äºæˆ‘</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">ä¸»é¡µ</a></li>
				        
							<li><a href="/archives">æ‰€æœ‰æ–‡ç« </a></li>
				        
							<li><a href="/tags/éšç¬”">éšç¬”</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/aeronxie" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/1919135421/home?wvr=5" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/xie-fei-75-92" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="https://mail.google.com/mail/#inbox" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Block/" style="font-size: 10px;">Block</a> <a href="/tags/C/" style="font-size: 12.5px;">C++</a> <a href="/tags/CentOS/" style="font-size: 10px;">CentOS</a> <a href="/tags/CocoaPods/" style="font-size: 10px;">CocoaPods</a> <a href="/tags/GCD/" style="font-size: 10px;">GCD</a> <a href="/tags/Git/" style="font-size: 12.5px;">Git</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/JS/" style="font-size: 10px;">JS</a> <a href="/tags/Mach-O/" style="font-size: 12.5px;">Mach-O</a> <a href="/tags/Objc/" style="font-size: 10px;">Objc</a> <a href="/tags/Objective-C/" style="font-size: 17.5px;">Objective-C</a> <a href="/tags/PPTP/" style="font-size: 10px;">PPTP</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Reactivecocoa/" style="font-size: 10px;">Reactivecocoa</a> <a href="/tags/Reveal/" style="font-size: 10px;">Reveal</a> <a href="/tags/Runloop/" style="font-size: 10px;">Runloop</a> <a href="/tags/Runtime/" style="font-size: 10px;">Runtime</a> <a href="/tags/VPN/" style="font-size: 10px;">VPN</a> <a href="/tags/VPS/" style="font-size: 10px;">VPS</a> <a href="/tags/Xcode/" style="font-size: 10px;">Xcode</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/iOS11/" style="font-size: 10px;">iOS11</a> <a href="/tags/lock/" style="font-size: 10px;">lock</a> <a href="/tags/runtime/" style="font-size: 15px;">runtime</a> <a href="/tags/verson/" style="font-size: 10px;">verson</a> <a href="/tags/ä¼ æ„Ÿå™¨/" style="font-size: 10px;">ä¼ æ„Ÿå™¨</a> <a href="/tags/åŠ¨ç”»/" style="font-size: 10px;">åŠ¨ç”»</a> <a href="/tags/æ¨é€/" style="font-size: 10px;">æ¨é€</a> <a href="/tags/æ•°æ®ç»“æ„/" style="font-size: 10px;">æ•°æ®ç»“æ„</a> <a href="/tags/è…¾è®¯/" style="font-size: 10px;">è…¾è®¯</a> <a href="/tags/é“¾è¡¨/" style="font-size: 10px;">é“¾è¡¨</a> <a href="/tags/éšç¬”/" style="font-size: 12.5px;">éšç¬”</a> <a href="/tags/é¢è¯•/" style="font-size: 12.5px;">é¢è¯•</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://laichanwai.github.io/">Ivyçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://maru-zhang.github.io">maruçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/users/b82d2721ba07/latest_articles">å¶å­¤åŸçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.onevcat.com/">å–µç¥çš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://kittenyang.com/">Kitten Yongçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.ibireme.com/">Ibiremeçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.sunnyxx.com/">æˆ‘å°±å«Sunnyçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.devtang.com/">å”å·§çš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.desgard.com/">ç“œçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://draveness.me/">Dravenessçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://southpeak.github.io/">å—å³°å­çš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/u/12201cdd5d7a">å†°éœœçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/u/3e55748920d2">Bestswiftçš„åšå®¢</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.cnbang.net/">bangç¥</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://fullstack.blog/">fullstack</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">ä¸€ä¸ªäºŒæµå¤§å­¦å–œæ¬¢iOSå¼€å‘çš„ä¸€ä¸ªå¤§å­¦ç”Ÿï¼Œå–œæ¬¢å„ç§æ–°é²œäº‹ç‰©ï¼Œä¼šandroid \ swift \ python \ java \ C \ javascript \ mysql \ jspå•è¯çš„æ‹¼å†™~~~~</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Aeron_Xie</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/32269?v=3&amp;s=460" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Aeron_Xie</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">ä¸»é¡µ</a></li>
		        
					<li><a href="/archives">æ‰€æœ‰æ–‡ç« </a></li>
		        
					<li><a href="/tags/éšç¬”">éšç¬”</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/aeronxie" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/1919135421/home?wvr=5" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/xie-fei-75-92" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="https://mail.google.com/mail/#inbox" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/29/æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰/" class="article-date">
  	<time datetime="2017-09-29T09:41:56.000Z" itemprop="datePublished">2017-09-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lock/">lock</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>ğŸ”é¡¾åæ€ä¹‰ã€‚ã€‚é”ä¸Šäº†è¡¨ç¤ºå°±è¿›ä¸æ¥ï¼Œè§£é”åä½ æ‰å¯ä»¥è¿›æ¥ã€‚ã€‚åœ¨å¼€å‘ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåœ¨å¤šçº¿ç¨‹å¼€å‘ä¸­ï¼Œå°±ç»å¸¸ä¼šä½¿ç”¨åˆ°é”æœºåˆ¶ã€‚é”æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸­å¯¹èµ„æºçš„è®¿é—®é™åˆ¶ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´æ“ä½œèµ„æº.</p>
<p>ä¸åŒçš„é”çš„æ€§èƒ½ä¸å®ç°ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å°±æ¥ç ”ç©¶ä¸‹åœ¨iOSä¸­çš„å‡ ç§ä¸åŒçš„é”~~</p>
</blockquote>
<a id="more"></a>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™ä¸ªå›¾</p>
<p><img src="http://7xoijj.com1.z0.glb.clouddn.com/2017031601.png" alt=""></p>
<p>è¿™ä¸ªæ˜¯Yç¥åœ¨å¯¹é”çš„æ€§èƒ½æµ‹è¯•åå¾—åˆ°çš„ä¸€ä¸ªç»“è®º, æš‚ä¸”ä¸è®¨è®ºæ€§èƒ½ï¼Œæˆ‘ä»¬æŒ‰ä»ä¸Šåˆ°ä¸‹æ¥çœ‹ä¸‹è¿™äº›é”éƒ½æ˜¯æ€ä¹ˆæ ·å®ç°çš„ã€‚</p>
<h2 id="OSSpinLockï¼ˆè‡ªæ—‹é”ï¼‰">OSSpinLockï¼ˆè‡ªæ—‹é”ï¼‰</h2><p><a href="https://en.wikipedia.org/wiki/Spinlock" target="_blank" rel="external">SpinLock</a>åˆç§°è‡ªæ—‹é”,çº¿ç¨‹é€šè¿‡<code>busy-wait-loop</code>çš„æ–¹å¼æ¥è·å–é”ï¼Œä»»æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å¾—é”ï¼Œå…¶ä»–çº¿ç¨‹å¿™ç­‰ç›´åˆ°è·å¾—é”ã€‚å…¶å®ç°æ˜¯é€šè¿‡æ ‡å¿—ä½ã€ <code>test_and_set</code>æŒ‡ä»¤æ‰§è¡ŒåŸå­æ€§å’Œwhileå¾ªåå¯¹èµ„æºè¿›è¡Œé”æ“ä½œ</p>
<h3 id="ç¼ºç‚¹ï¼š">ç¼ºç‚¹ï¼š</h3><ul>
<li><p>å¯¹äºäº’æ–¥é”ï¼Œå¦‚æœèµ„æºå·²ç»è¢«å ç”¨ï¼Œèµ„æºç”³è¯·è€…åªèƒ½è¿›å…¥ç¡çœ çŠ¶æ€ã€‚ä½†æ˜¯è‡ªæ—‹é”ä¸ä¼šå¼•èµ·è°ƒç”¨è€…ç¡çœ ï¼Œå¦‚æœè‡ªæ—‹é”å·²ç»è¢«åˆ«çš„æ‰§è¡Œå•å…ƒä¿æŒï¼Œè°ƒç”¨è€…å°±ä¸€ç›´å¾ªç¯(ä¹Ÿå°±æ˜¯å¿™ç­‰)åœ¨é‚£é‡Œçœ‹æ˜¯å¦è¯¥è‡ªæ—‹é”çš„ä¿æŒè€…å·²ç»é‡Šæ”¾äº†é”ï¼Œè¿™ä¹Ÿå°±æ˜¯è‡ªæ—‹é”æ¯”äº’æ–¥é”æ€§èƒ½å¥½çš„åŸå› . ä½†æ˜¯å‡è®¾æ˜¯æ—¶é—´è¾ƒé•¿çš„I/Oæ“ä½œï¼Œå°±ä¼šå ç”¨å¤§é‡çš„CPUæ—¶é—´,ä»è€Œä½¿é”çš„æ•ˆç‡é™ä½ï¼Œæ‰€ä»¥è‡ªæ—‹é”æ¯”è¾ƒé€‚ç”¨é”ä½¿ç”¨è€…ä¿æŒé”æ—¶é—´æ¯”è¾ƒçŸ­çš„æƒ…å†µ.</p>
</li>
<li><p>è‡ªæ—‹é”ä¸æ”¯æŒé€’å½’ï¼Œå¦‚æœé€’å½’è°ƒç”¨çš„è¯ä¼šé€ æˆæ­»é”. æ‰€ä»¥é€’å½’ç¨‹åºå†³ä¸èƒ½åœ¨æŒæœ‰è‡ªæ—‹é”æ—¶è°ƒç”¨å®ƒè‡ªå·±ï¼Œä¹Ÿå†³ä¸èƒ½åœ¨é€’å½’è°ƒç”¨æ—¶è¯•å›¾è·å¾—ç›¸åŒçš„è‡ªæ—‹é”</p>
</li>
</ul>
<p>è‡ªæ—‹é”ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OSSpinLock oslock = OS_SPINLOCK_INIT;</span><br><span class="line">OSSpinLockLock(&amp;oslock);</span><br><span class="line"><span class="comment">// do somthing</span></span><br><span class="line">OSSpinLockUnlock(&amp;oslock);</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è‡ªæ—‹é”æ˜¯æœ‰ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„bugï¼Œå‡è®¾ä¸€ä¸ªä½ä¼˜å…ˆçº§çš„çº¿ç¨‹è·å¾—äº†é”å¹¶è®¿é—®äº†èµ„æºï¼Œè¿™æ—¶ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¹Ÿå°è¯•è·å¾—è¿™ä¸ªé”ï¼Œæ­¤æ—¶å®ƒä¼šå¤„äº<code>busy-wait</code>å¿™ç­‰çŠ¶æ€ä»è€Œå ç”¨å¤§é‡ CPU æ—¶é—´ï¼Œæ­¤æ—¶ä½ä¼˜å…ˆçº§çº¿ç¨‹æ— æ³•ä¸é«˜ä¼˜å…ˆçº§çº¿ç¨‹äº‰å¤º <code>CPU</code> æ—¶é—´ï¼Œä»è€Œå¯¼è‡´ä»»åŠ¡ä¸èƒ½å®Œæˆæ— æ³•é‡Šæ”¾ <code>lock</code>, ç›´åˆ°è¶…æ—¶è¢«æ“ä½œç³»ç»ŸæŠ¢å . è¿™å°±é€ æˆäº†ä¼˜å…ˆçº§çš„åè½¬.</p>
<h2 id="Dispatch_semaphore_(ä¿¡å·é‡)">Dispatch_semaphore (ä¿¡å·é‡)</h2><p>åœ¨<a href="https://opensource.apple.com/tarballs/libdispatch/" target="_blank" rel="external">libdispatchæºç </a>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>semaphore.h</code>æ–‡ä»¶å‘ç°å…¶æä¾›çš„APIä¹Ÿæ˜¯ååˆ†çš„ç®€å•ï¼Œåªæœ‰ä¸‰ä¸ªå‡½æ•°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_semaphore_t dispatch_semaphore_create(<span class="keyword">long</span> value);  <span class="comment">// åˆ›å»ºä¸€ä¸ªä¿¡å·</span></span><br><span class="line"><span class="keyword">long</span> dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout);    <span class="comment">// ç­‰å¾…ä¿¡å·</span></span><br><span class="line"><span class="keyword">long</span> dispatch_semaphore_signal(dispatch_semaphore_t dsema);  <span class="comment">// å‘é€ä¿¡å·</span></span><br></pre></td></tr></table></figure>
<p><code>dispatch_semaphore_signal</code>å‘é€ä¸€ä¸ªä¿¡å·ï¼Œä¼šè®©ä¿¡å·æ€»é‡åŠ 1,<code>dispatch_semaphore_wait</code>ç”¨äºç­‰å¾…ä¿¡å·ï¼Œè®©ä¿¡å·æ€»é‡å‡1ï¼Œå½“ä¿¡å·æ€»é‡å°‘äº0çš„æ—¶å€™å°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œå¦åˆ™å°±å¯ä»¥æ­£å¸¸çš„æ‰§è¡Œï¼Œæ ¹æ®è¿™æ ·çš„åŸç†ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¿«é€Ÿçš„åˆ›å»ºä¸€ä¸ªå¹¶å‘æ§åˆ¶æ¥åŒæ­¥ä»»åŠ¡å’Œæœ‰é™èµ„æºè®¿é—®æ§åˆ¶</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout) &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (dispatch_atomic_dec(&amp;dsema-&gt;dsema_value) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_semaphore_wait_slow(dsema, timeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å»æ‰äº†ä¸­é—´çš„åœ¨ä¸åŒæ¶æ„ä¸‹çš„ä¼˜åŒ–éƒ¨åˆ†ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯è¿™æ ·</p>
<p><code>#define dispatch_atomic_dec(p)    __sync_sub_and_fetch((p), 1)</code> è¿™ä¸ªå®è°ƒç”¨çš„æ˜¯<code>__sync_sub_and_fetch</code>, è¿™æ˜¯ä¸ªGCCçš„å†…ç½®å‡½æ•°ï¼Œå®ƒå®ç°äº†å‡æ³•çš„åŸå­æ€§æ“ä½œ, å°†<code>dsema_value</code>çš„å€¼å‡ä¸€ï¼Œå¹¶æŠŠæ–°çš„å€¼èµ‹ç»™<code>dsema_value</code>,å¦‚æœä¿¡å·é‡çš„å€¼å‡1ä¹‹åå¤§äºç­‰äº0ï¼Œè¡¨ç¤ºæœ‰èµ„æºå¯ç”¨ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›0, å¦åˆ™å°†ä¼šéƒ½åˆ°<code>_dispatch_semaphore_wait_slow</code>å‡½æ•°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">long</span> _dispatch_semaphore_wait_slow(dispatch_semaphore_t dsema, dispatch_time_t timeout) &#123;</span><br><span class="line">	mach_timespec_t _timeout;</span><br><span class="line">	kern_return_t kr;</span><br><span class="line">	uint64_t nsec;</span><br><span class="line">	<span class="keyword">long</span> orig;</span><br><span class="line">	</span><br><span class="line">again:</span><br><span class="line">	<span class="comment">// Mach semaphores appear to sometimes spuriously wake up.  Therefore,</span></span><br><span class="line">	<span class="comment">// we keep a parallel count of the number of times a Mach semaphore is</span></span><br><span class="line">	<span class="comment">// signaled.</span></span><br><span class="line">	<span class="keyword">while</span> ((orig = dsema-&gt;dsema_sent_ksignals)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (dispatch_atomic_cmpxchg(&amp;dsema-&gt;dsema_sent_ksignals, orig, orig - <span class="number">1</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_dispatch_semaphore_create_port(&amp;dsema-&gt;dsema_port);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// From xnu/osfmk/kern/sync_sema.c:</span></span><br><span class="line">	<span class="comment">// wait_semaphore-&gt;count = -1;  /* we don't keep an actual count */</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// The code above does not match the documentation, and that fact is</span></span><br><span class="line">	<span class="comment">// not surprising. The documented semantics are clumsy to use in any</span></span><br><span class="line">	<span class="comment">// practical way. The above hack effectively tricks the rest of the</span></span><br><span class="line">	<span class="comment">// Mach semaphore logic to behave like the libdispatch algorithm.</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (timeout) &#123;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="comment">// timeout() already calculates relative time left</span></span><br><span class="line">			nsec = _dispatch_timeout(timeout);</span><br><span class="line">			_timeout<span class="variable">.tv_sec</span> = (<span class="keyword">typeof</span>(_timeout<span class="variable">.tv_sec</span>))(nsec / <span class="built_in">NSEC_PER_SEC</span>);</span><br><span class="line">			_timeout<span class="variable">.tv_nsec</span> = (<span class="keyword">typeof</span>(_timeout<span class="variable">.tv_nsec</span>))(nsec % <span class="built_in">NSEC_PER_SEC</span>);</span><br><span class="line">			kr = slowpath(semaphore_timedwait(dsema-&gt;dsema_port, _timeout));</span><br><span class="line">		&#125; <span class="keyword">while</span> (kr == KERN_ABORTED);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (kr != KERN_OPERATION_TIMED_OUT) &#123;</span><br><span class="line">			DISPATCH_SEMAPHORE_VERIFY_KR(kr);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Fall through and try to undo what the fast path did to dsema-&gt;dsema_value</span></span><br><span class="line">	<span class="keyword">case</span> DISPATCH_TIME_NOW:</span><br><span class="line">		<span class="keyword">while</span> ((orig = dsema-&gt;dsema_value) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (dispatch_atomic_cmpxchg(&amp;dsema-&gt;dsema_value, orig, orig + <span class="number">1</span>)) &#123;</span><br><span class="line">				<span class="keyword">return</span> KERN_OPERATION_TIMED_OUT;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Another thread called semaphore_signal().</span></span><br><span class="line">		<span class="comment">// Fall through and drain the wakeup.</span></span><br><span class="line">	<span class="keyword">case</span> DISPATCH_TIME_FOREVER:</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			kr = semaphore_wait(dsema-&gt;dsema_port);</span><br><span class="line">		&#125; <span class="keyword">while</span> (kr == KERN_ABORTED);</span><br><span class="line">		DISPATCH_SEMAPHORE_VERIFY_KR(kr);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">goto</span> again;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥è¿™ä¸ªæ–¹æ³•ï¼Œ<code>timeout</code>æœ‰ä¸‰ç§caseï¼š</p>
<ul>
<li><p>DISPATCH _TIME _NOW: ä¸ç­‰å¾…, å¦‚æœ<code>dsema_value</code>å°äº0ï¼Œé‚£ä¹ˆå°†å…¶+1, ç„¶åè¿”å›<code>KERN_OPERATION_TIMED_OUT</code>ï¼› å¦‚æœå¤§äºç­‰äº0ï¼Œè¡¨ç¤ºæœ‰èµ„æºå¯ç”¨ï¼Œé‚£ä¹ˆå°†ä¼šè¿›å…¥åˆ°again;</p>
</li>
<li><p>DISPATCH _TIME _FOREVER: æ— çº¿ç­‰å¾…, <code>semaphore_wait</code>å°†æ— é™ç­‰å¾…åˆ°ä¿¡å·å€¼ç­‰äºäº<code>KERN_ABORTED</code>;<br>ç­‰ä¿¡å·æ¥äº†ï¼Œè·³è½¬åˆ°again;</p>
</li>
<li><p>Default: è®¡æ—¶ç­‰å¾…, <code>semaphore_timedwait(dsema-&gt;dsema_port, _timeout)</code>ç›´åˆ°<code>timeout</code>æˆ–è€…<code>KERN_ABORTED</code>ä¸ºæ­¢</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> dispatch_semaphore_signal(dispatch_semaphore_t dsema) &#123;</span><br><span class="line">	<span class="keyword">if</span> (dispatch_atomic_inc(&amp;dsema-&gt;dsema_value) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_semaphore_signal_slow(dsema);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘é€ä¿¡å·ä¸ç­‰å¾…ä¿¡å·çš„å‡½æ•°å·®ä¸å¤š, <code>dispatch_atomic_inc</code>, <code>#define dispatch_atomic_inc(p)    __sync_add_and_fetch((p), 1)</code> è¿™ä¹Ÿæ˜¯ä¸€ä¸ªGCCå†…ç½®å‡½æ•°, è‹¥ä¿¡å·å€¼åŠ 1åå¤§äºé›¶ï¼Œè¡¨ç¤ºæœ‰èµ„æºå¯ç”¨ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›0, å¦åˆ™å°†ä¼šèµ°åˆ°<code>_dispatch_semaphore_signal_slow</code>ä¸­</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">long</span> _dispatch_semaphore_signal_slow(dispatch_semaphore_t dsema) &#123;</span><br><span class="line">	kern_return_t kr;</span><br><span class="line">	</span><br><span class="line">	_dispatch_semaphore_create_port(&amp;dsema-&gt;dsema_port);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Before dsema_sent_ksignals is incremented we can rely on the reference</span></span><br><span class="line">	<span class="comment">// held by the waiter. However, once this value is incremented the waiter</span></span><br><span class="line">	<span class="comment">// may return between the atomic increment and the semaphore_signal(),</span></span><br><span class="line">	<span class="comment">// therefore an explicit reference must be held in order to safely access</span></span><br><span class="line">	<span class="comment">// dsema after the atomic increment.</span></span><br><span class="line">	_dispatch_retain(dsema);</span><br><span class="line">	</span><br><span class="line">	dispatch_atomic_inc(&amp;dsema-&gt;dsema_sent_ksignals);</span><br><span class="line">	</span><br><span class="line">	kr = semaphore_signal(dsema-&gt;dsema_port);</span><br><span class="line">	DISPATCH_SEMAPHORE_VERIFY_KR(kr);</span><br><span class="line"></span><br><span class="line">	_dispatch_release(dsema);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¿¡å·é‡ä¹‹å‰çš„å€¼å°äº0ï¼Œé‚£ä¹ˆä¿¡å·é‡åŠ 1ï¼›å…¶æ ¸å¿ƒæ˜¯:<code>semaphore_signal(dsema-&gt;dsema_port)</code> åˆ©ç”¨ç³»ç»Ÿçš„ä¿¡å·é‡åº“å®ç°å‘é€ä¿¡å·é‡çš„åŠŸèƒ½ï¼Œæœ€åè¿”å›1, è¡¨ç¤ºå…¶å½“å‰æœ‰ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰çº¿ç¨‹ç­‰å¾…å…¶å¤„ç†çš„ä¿¡å·é‡ï¼Œå¹¶ä¸”è¯¥å‡½æ•°å”¤é†’äº†ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹(å½“çº¿ç¨‹æœ‰ä¼˜å…ˆçº§æ—¶ï¼Œå”¤é†’ä¼˜å…ˆçº§æœ€é«˜çš„çº¿ç¨‹ï¼›å¦åˆ™éšæœºå”¤é†’).</p>
<p>ä¿¡å·é‡ä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);   </span><br><span class="line">dispatch_semaphore_signal(semaphore);   </span><br><span class="line">dispatch_group_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br></pre></td></tr></table></figure>
<h2 id="pthread_mutex">pthread_mutex</h2><p><code>pthread</code> è¡¨ç¤º <code>POSIX</code>æ ‡å‡†çš„çº¿ç¨‹åº“ï¼Œè¯¥æ ‡å‡†å®šä¹‰äº†åˆ›å»ºå’Œæ“çºµçº¿ç¨‹çš„ä¸€æ•´å¥—API, <code>pthread_mutex</code> è¡¨ç¤ºçš„æ˜¯äº’æ–¥é”</p>
<p>POSIXä¸‹æŠ½è±¡äº†ä¸€ä¸ªé”ç±»å‹çš„ç»“æ„ï¼š<code>ptread _mutex _t</code>  æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹åœ¨iOSä¸­ï¼Œæ˜¯æ€ä¹ˆå®šä¹‰çš„ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> __darwin_pthread_mutex_t pthread_mutex_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _opaque_pthread_mutex_t __darwin_pthread_mutex_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> _opaque_pthread_mutex_t &#123;</span><br><span class="line">	<span class="keyword">long</span> __sig;</span><br><span class="line">	<span class="keyword">char</span> __opaque[__PTHREAD_MUTEX_SIZE__];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>ptread _mutex _t</code>å…¶å®å°±æ˜¯ä¸€ä¸ª<code>_opaque_pthread_mutex_t</code>ç»“æ„ä½“, å…¶åŸç†ä¸ä¿¡å·é‡ç±»ä¼¼,ä¸ä½¿ç”¨å¿™ç­‰ï¼Œè€Œæ˜¯é˜»å¡çº¿ç¨‹å¹¶ç¡çœ ï¼Œéœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡çš„åˆ‡æ¢. PS:ä¸€ä¸ªçº¿ç¨‹åªèƒ½ç”³è¯·ä¸€æ¬¡é”ï¼Œåªæœ‰åœ¨è·å¾—é”çš„æƒ…å†µä¸‹æ‰èƒ½é‡Šæ”¾é”ï¼Œå¤šæ¬¡ç”³è¯·é”æˆ–é‡Šæ”¾æœªè·å¾—çš„é”éƒ½ä¼šå¯¼è‡´å´©æºƒ.</p>
<p>å› ä¸º<code>ptread _mutex _t</code>æ”¯æŒå¤šç§ç±»å‹, åœ¨ç”³è¯·åŠ é”æ—¶ï¼Œéœ€è¦å¯¹é”çš„ç±»å‹è¿›è¡Œåˆ¤æ–­, è™½ç„¶å®ç°è·Ÿä¿¡å·é‡å·®ä¸å¤šï¼Œä½†æ˜¯æ€§èƒ½å´ç•¥ä½ä¸€äº›.</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹å…¶æä¾›çš„API</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºé” å¯ä»¥ä¼ ä¸€ä¸ªå±æ€§ä¸º `pthread_mutexattr_t` ç±»å‹çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">int</span> pthread_mutex_init(pthread_mutex_t * __restrict,<span class="keyword">const</span> pthread_mutexattr_t * _Nullable __restrict);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”³è¯·é”</span></span><br><span class="line"><span class="keyword">int</span> pthread_mutex_lock(pthread_mutex_t *);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line"><span class="keyword">int</span> pthread_mutex_unlock(pthread_mutex_t *);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  åˆå§‹åŒ–äº’æ–¥é”å±æ€§å¯¹è±¡</span></span><br><span class="line"><span class="keyword">int</span> pthread_mutexattr_init(pthread_mutexattr_t *);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ºæ‰€å±æ€§å¯¹è±¡è®¾ç½®ç±»å‹</span></span><br><span class="line"><span class="keyword">int</span> pthread_mutexattr_settype(pthread_mutexattr_t *, <span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹</span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * Mutex type attributes</span><br><span class="line"> */</span></span><br><span class="line"><span class="preprocessor">#define PTHREAD_MUTEX_NORMAL		0       // æ™®é€š</span></span><br><span class="line"><span class="preprocessor">#define PTHREAD_MUTEX_ERRORCHECK	1       // errorcheck</span></span><br><span class="line"><span class="preprocessor">#define PTHREAD_MUTEX_RECURSIVE		2   // é€’å½’</span></span><br><span class="line"><span class="preprocessor">#define PTHREAD_MUTEX_DEFAULT		PTHREAD_MUTEX_NORMAL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼šå°è¯•åŠ é”ï¼Œå¦‚æœè¯¥äº’æ–¥é”å·²ç»é”å®šï¼Œåˆ™è¿”å›ä¸€ä¸ªä¸ä¸º0çš„é”™è¯¯å€¼ï¼Œå¦‚æœè¯¥äº’æ–¥é”æ²¡æœ‰é”å®šï¼Œåˆ™è¿”å›0ï¼Œè¡¨ç¤ºå°è¯•åŠ é”æˆåŠŸ</span></span><br><span class="line"><span class="keyword">int</span> pthread_mutex_trylock(pthread_mutex_t *);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”€æ¯é”,é”€æ¯æˆåŠŸåˆ™ä¼šè¿”å›0,å¦åˆ™ä¼šè¿”å›é”™è¯¯ç </span></span><br><span class="line"><span class="keyword">int</span> pthread_mutex_destroy(pthread_mutex_t *);</span><br></pre></td></tr></table></figure>
<p>æ¥çœ‹ä¸‹ä½¿ç”¨æ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutexattr_t attr;       <span class="comment">// å®šä¹‰ä¸€ä¸ªé”å±æ€§å¯¹è±¡</span></span><br><span class="line">pthread_mutexattr_init(&amp;attr);  <span class="comment">// åˆå§‹åŒ–é”å±æ€§å¯¹è±¡</span></span><br><span class="line">pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_NORMAL);  <span class="comment">// ä¸ºé”è®¾ç½®çš„å±æ€§ç±»å‹</span></span><br><span class="line"></span><br><span class="line">pthread_mutex_t mutex;   <span class="comment">// å®šä¹‰ä¸€ä¸ªé”å¯¹è±¡</span></span><br><span class="line">pthread_mutex_init(&amp;mutex, &amp;attr) <span class="comment">// åˆ›å»ºé”</span></span><br><span class="line">pthread_mutex_lock(&amp;mutex); <span class="comment">// ç”³è¯·é”  </span></span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line">pthread_mutex_unlock(&amp;mutex); <span class="comment">// é‡Šæ”¾é”  </span></span><br><span class="line">pthread_mutex_destroy(&amp;mutex); <span class="comment">// é”€æ¯é”</span></span><br></pre></td></tr></table></figure>
<h2 id="NSLock">NSLock</h2><p>ç”±äºGNUçš„æºç æ˜¯å¼€æºçš„ï¼Œä¹Ÿè·ŸCocoaçš„å®ç°å·®ä¸å¤šï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“ç®—ä½¿ç”¨ <a href="http://www.gnustep.org/resources/downloads.php" target="_blank" rel="external">GNUæºç </a> æ¥åˆ†æ<code>NSLock</code></p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<code>NSLock</code>çš„æ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>) initialize &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">BOOL</span>	beenHere = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (beenHere == <span class="literal">NO</span>) &#123;</span><br><span class="line">      beenHere = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Initialise attributes for the different types of mutex.</span><br><span class="line">       * We do it once, since attributes can be shared between multiple</span><br><span class="line">       * mutexes.</span><br><span class="line">       * If we had a pthread_mutexattr_t instance for each mutex, we would</span><br><span class="line">       * either have to store it as an ivar of our NSLock (or similar), or</span><br><span class="line">       * we would potentially leak instances as we couldn't destroy them</span><br><span class="line">       * when destroying the NSLock.  I don't know if any implementation</span><br><span class="line">       * of pthreads actually allocates memory when you call the</span><br><span class="line">       * pthread_mutexattr_init function, but they are allowed to do so</span><br><span class="line">       * (and deallocate the memory in pthread_mutexattr_destroy).</span><br><span class="line">       */</span></span><br><span class="line">      pthread_mutexattr_init(&amp;attr_normal);</span><br><span class="line">      pthread_mutexattr_settype(&amp;attr_normal, PTHREAD_MUTEX_NORMAL);</span><br><span class="line">      pthread_mutexattr_init(&amp;attr_reporting);</span><br><span class="line">      pthread_mutexattr_settype(&amp;attr_reporting, PTHREAD_MUTEX_ERRORCHECK);</span><br><span class="line">      pthread_mutexattr_init(&amp;attr_recursive);</span><br><span class="line">      pthread_mutexattr_settype(&amp;attr_recursive, PTHREAD_MUTEX_RECURSIVE);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* To emulate OSX behavior, we need to be able both to detect deadlocks</span><br><span class="line">       * (so we can log them), and also hang the thread when one occurs.</span><br><span class="line">       * the simple way to do that is to set up a locked mutex we can</span><br><span class="line">       * force a deadlock on.</span><br><span class="line">       */</span></span><br><span class="line">      pthread_mutex_init(&amp;deadlock, &amp;attr_normal);</span><br><span class="line">      pthread_mutex_lock(&amp;deadlock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>NSLock</code>ç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆå§‹åŒ–äº†ä¸‰ç§å±æ€§,<code>attr_normal</code>ã€<code>attr_reporting</code>ã€<code>attr_recursive</code>,å¯¹åº”çš„ç±»å‹åˆ†åˆ«æ˜¯<code>PTHREAD_MUTEX_NORMAL</code>ã€<code>PTHREAD_MUTEX_ERRORCHECK</code>ã€<code>PTHREAD_MUTEX_RECURSIVE</code>,<br>å½“æ‰§è¡Œ<code>NSLock</code>çš„<code>init</code>æ–¹æ³•æ—¶ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Use an error-checking lock.  This is marginally slower, but lets us throw</span><br><span class="line"> * exceptions when incorrect locking occurs.</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">id</span>) init &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> != (<span class="keyword">self</span> = [<span class="keyword">super</span> init])) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">0</span> != pthread_mutex_init(&amp;_mutex, &amp;attr_reporting)) &#123;</span><br><span class="line">	  	  DESTROY(<span class="keyword">self</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–çš„æ˜¯å±æ€§ä¸º<code>attr_reporting</code>çš„é”ï¼Œä¹Ÿå°±æ˜¯<code>error-checking</code>é”, è¿™æ ·æ€§èƒ½ç›¸æ¯”äº<code>attr_normal</code>çš„é”ï¼Œä¼šç¨ç¨é™ä½ï¼Œå› ä¸ºå®ƒä¼šåœ¨å‘ç”Ÿæç¤ºæ—¶ç‰ºç‰²ä¸€å®šçš„æ€§èƒ½æ¥æ¢å–æç¤ºé”™è¯¯ä¿¡æ¯</p>
<p>å®ƒæä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å†…éƒ¨è°ƒç”¨çš„è¿˜æ˜¯`pthread_mutex`çš„ `pthread_mutex_trylock `æ–¹æ³•, å¦‚æœå°è¯•åŠ é”æˆåŠŸåˆ™è¿”å›YESå¦åˆ™ä¸ºNO</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)tryLock &#123;</span><br><span class="line">    <span class="keyword">int</span> err = pthread_mutex_trylock(&amp;_mutex);</span><br><span class="line">  	 <span class="keyword">return</span> (<span class="number">0</span> == err) ? <span class="literal">YES</span> : <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯¥æ–¹æ³•ä¼šåœ¨æ‰€æŒ‡å®š `Date` ä¹‹å‰å°è¯•åŠ é”ï¼Œä¼šé˜»å¡çº¿ç¨‹ï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´ä¹‹å‰éƒ½ä¸èƒ½åŠ é”ï¼Œåˆ™è¿”å› NOï¼ŒæŒ‡å®šæ—¶é—´ä¹‹å‰èƒ½åŠ é”ï¼Œåˆ™è¿”å› YES</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)lockBeforeDate:(<span class="built_in">NSDate</span> *)limit &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> err = pthread_mutex_trylock(&amp;_mutex);</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">0</span> == err) &#123;</span><br><span class="line">		  <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">		&#125;</span><br><span class="line">      <span class="keyword">if</span> (EDEADLK == err) &#123;</span><br><span class="line">		  _<span class="built_in">NSLockError</span>(<span class="keyword">self</span>, _cmd, <span class="literal">NO</span>)\<span class="number">3</span></span><br><span class="line">	   &#125;</span><br><span class="line">      sched_yield();</span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">while</span> ([limit timeIntervalSinceNow] &gt; <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sched_yield</code>å‡½æ•°å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªçº§åˆ«ç­‰äºæˆ–é«˜äºå½“å‰çº¿ç¨‹çš„çº¿ç¨‹å…ˆè¿è¡Œ.å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°†ä¼šç«‹åˆ»è¿”å›ç„¶åç»§ç»­æ‰§è¡Œå½“å‰çº¿ç¨‹çš„ç¨‹åº.</p>
<p><code>NSLcok</code>ä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå› ä¸ºéµå¾ªäº†<code>&lt;NSLocking&gt;</code>åè®®ï¼Œåè®®ä¸­ä»…æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œ<code>- (void)lock;``- (void)unlock;</code> æ‰€ä»¥<code>NSLock</code>å¯¹è±¡å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¿©ä¸ªæ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLock</span> *lock = [[<span class="built_in">NSLock</span> alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ([lock tryLock]) &#123; <span class="comment">// å°è¯•åŠ é”ï¼Œå¦‚æœå¤±è´¥è¿”å›NOï¼Œä¸ä¼šé˜»å¡è¯¥çº¿ç¨‹</span></span><br><span class="line">	[lock unlock];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ([lock lockBeforeDate:date]) &#123; <span class="comment">// åœ¨Dateä¹‹å‰å°è¯•åŠ é”ï¼Œå¦‚æœä¸èƒ½åŠ é”ï¼Œåˆ™è¿”å›NO</span></span><br><span class="line">	[lock unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="NSConditionï¼ˆæ¡ä»¶å˜é‡ï¼‰">NSConditionï¼ˆæ¡ä»¶å˜é‡ï¼‰</h2><p>ä½¿ç”¨<code>NSCondition</code>ï¼ˆæ¡ä»¶å˜é‡ï¼‰å¯¹è±¡æ¥æ§åˆ¶è¿›ç¨‹çš„åŒæ­¥ï¼Œå³å¯å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ã€‚å…¶å†…éƒ¨æ˜¯é€šè¿‡<code>pthread_cond_t</code>æ¥å®ç°. <code>NSCondition</code>æ˜¯åˆ©ç”¨çº¿ç¨‹é—´å…±äº«çš„å…¨å±€å˜é‡è¿›è¡ŒåŒæ­¥çš„ä¸€ç§æœºåˆ¶ï¼Œ<code>NSCondition</code>ä¹Ÿå®ç°äº†<code>NSLocking</code>åè®®ï¼Œå› æ­¤ä¹Ÿå¯ä»¥è°ƒç”¨<code>lock</code>ã€ <code>unlock</code>æ¥å®ç°çº¿ç¨‹çš„åŒæ­¥, ä¸ºäº†é˜²æ­¢ç«äº‰ï¼Œæ¡ä»¶å˜é‡çš„ä½¿ç”¨æ€»æ˜¯å’Œä¸€ä¸ªäº’æ–¥é”ç»“åˆåœ¨ä¸€èµ·.</p>
<h4 id="ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼">ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼</h4><p>é¦–å…ˆè¦åˆ›å»ºå…¬ç”¨çš„NSConditionå®ä¾‹ã€‚ç„¶åï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…å–å¾—é”ï¼Œå–äº§å“ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™waitï¼Œè¿™æ—¶ä¼šé‡Šæ”¾é”ï¼Œç›´åˆ°æœ‰çº¿ç¨‹å”¤é†’å®ƒå»æ¶ˆè´¹äº§å“ï¼›</li>
<li>ç”Ÿäº§è€…åˆ¶é€ äº§å“ï¼Œé¦–å…ˆä¹Ÿæ˜¯è¦å–å¾—é”ï¼Œç„¶åç”Ÿäº§ï¼Œå†å‘signalï¼Œè¿™æ ·å¯å”¤é†’waitçš„æ¶ˆè´¹è€…ã€‚</li>
</ul>
<p><code>NSCondition</code>æä¾›äº†è¿™ä¹ˆäº›APIï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)wait; <span class="comment">// è®©å½“å‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)waitUntilDate:(<span class="built_in">NSDate</span> *)limit;</span><br><span class="line">- (<span class="keyword">void</span>)signal; <span class="comment">// CPUå‘ä¿¡å·å‘Šè¯‰çº¿ç¨‹ä¸ç”¨åœ¨ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">- (<span class="keyword">void</span>)broadcast; <span class="comment">// å”¤é†’ç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’åœ¨æ­¤NSConditionå¯¹è±¡ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹    </span></span><br><span class="line">- (<span class="keyword">void</span>)broadcast &#123;</span><br><span class="line">  pthread_cond_broadcast(&amp;_condition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSCondition çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œé€šè¿‡`pthread_cond_init`åˆ›å»ºä¸€ä¸ªæ¡ä»¶å¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ–ä¸€ä¸ªå±æ€§ä¸º`attr_reporting `çš„é”</span></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> != (<span class="keyword">self</span> = [<span class="keyword">super</span> init])) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">0</span> != pthread_cond_init(&amp;_condition, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">		  DESTROY(<span class="keyword">self</span>);</span><br><span class="line">	   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> != pthread_mutex_init(&amp;_mutex, &amp;attr_reporting)) &#123;</span><br><span class="line">		  pthread_cond_destroy(&amp;_condition);</span><br><span class="line">		  DESTROY(<span class="keyword">self</span>);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å”¤é†’åœ¨æ­¤NSConditionå¯¹è±¡ä¸Šç­‰å¾…çš„å•ä¸ªçº¿ç¨‹</span></span><br><span class="line">- (<span class="keyword">void</span>)signal &#123;</span><br><span class="line">  pthread_cond_signal(&amp;_condition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯¥æ–¹æ³•è®©çº¿ç¨‹ä¸€ç›´ç­‰å¾…</span></span><br><span class="line">- (<span class="keyword">void</span>)wait &#123;</span><br><span class="line">  pthread_cond_wait(&amp;_condition, &amp;_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸€ç›´ç­‰å¾…ç›´åˆ°è¶…æ—¶æ—¶é—´</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)waitUntilDate: (<span class="built_in">NSDate</span>*)limit &#123;</span><br><span class="line">  <span class="built_in">NSTimeInterval</span> t = [limit timeIntervalSince1970];</span><br><span class="line">  <span class="keyword">double</span> secs, subsecs;</span><br><span class="line">  <span class="keyword">struct</span> timespec timeout;</span><br><span class="line">  <span class="keyword">int</span> retVal = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Split the float into seconds and fractions of a second</span></span><br><span class="line">  subsecs = modf(t, &amp;secs);</span><br><span class="line">  timeout<span class="variable">.tv_sec</span> = secs;</span><br><span class="line">  <span class="comment">// Convert fractions of a second to nanoseconds</span></span><br><span class="line">  timeout<span class="variable">.tv_nsec</span> = subsecs * <span class="number">1e9</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®ç­‰å¾…æ¡ä»¶å˜é‡condï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™è¿”å›ï¼›å¦‚æœç­‰å¾…åˆ°æ¡ä»¶å˜é‡condï¼Œä¹Ÿè¿”å› </span></span><br><span class="line">   retVal = pthread_cond_timedwait(&amp;_condition, &amp;_mutex, &amp;timeout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (retVal == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (retVal == EINVAL) &#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@"Invalid arguments to pthread_cond_timedwait"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ¥çœ‹ä¸‹ä½¿ç”¨æ–¹æ³•:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºæ¶ˆè´¹è€…</span></span><br><span class="line">- (<span class="keyword">void</span>)createConsumenr &#123;</span><br><span class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">		[condition lock];</span><br><span class="line">	    <span class="keyword">while</span> (products<span class="variable">.count</span> == <span class="number">0</span>) &#123;</span><br><span class="line">	        <span class="built_in">NSLog</span>(<span class="string">@"wait for products"</span>);</span><br><span class="line">	        [condition wait];</span><br><span class="line">	    &#125;</span><br><span class="line">	    [products removeObjectAtIndex:<span class="number">0</span>];</span><br><span class="line">	    <span class="built_in">NSLog</span>(<span class="string">@"comsume a product"</span>);</span><br><span class="line">	    [condition unlock];</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç”Ÿäº§è€…</span></span><br><span class="line">- (<span class="keyword">void</span>)createProducter &#123;</span><br><span class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">		 [condition lock];</span><br><span class="line">	    [products addObject:[[<span class="built_in">NSObject</span> alloc] init]];</span><br><span class="line">	    <span class="built_in">NSLog</span>(<span class="string">@"produce a product"</span>);</span><br><span class="line">	    [condition signal];</span><br><span class="line">	    [condition unlock];</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“<code>condition</code>è¿›å…¥åˆ°åˆ¤æ–­æ¡ä»¶ä¸­ï¼Œ<code>products.count == 0</code>æ—¶ï¼Œ<code>condition</code>è°ƒç”¨<code>wait</code>ä½¿å½“å‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼›å…¶ä»–çº¿ç¨‹å¼€å§‹è®¿é—®<code>products</code>ï¼Œå½“<code>NSObject</code>åˆ›å»ºå®Œæˆå¹¶åŠ å…¥åˆ°<code>products</code>æ—¶ï¼Œcpuå‘å‡º<code>single</code>çš„ä¿¡å·æ—¶ï¼Œå¤„äºç­‰å¾…çš„çº¿ç¨‹è¢«å”¤é†’ï¼Œå¼€å§‹æ‰§è¡Œ<code>[products removeObjectAtIndex:0]</code></p>
<h2 id="pthread_mutex_(recursive)">pthread_mutex (recursive)</h2><p>è¿™ä¸ªå°±æ˜¯ä¸Šæ–‡è¯´çš„<code>pthread_mutex</code>, ä½†å®ƒçš„å±æ€§ç±»å‹æ˜¯<code>PTHREAD_MUTEX_RECURSIVE</code>, ä¹Ÿå°±æ˜¯æ”¯æŒé€’å½’ï¼Œå…è®¸ä¸€ä¸ªçº¿ç¨‹é€’å½’çš„ç”³è¯·é”ï¼Œè€Œä¸ä¼šé€ æˆæ­»é”. è¿™ä¸ç­‰ä¼šè¯´åˆ°çš„<code>NSRecursiveLock</code>å®ç°ç±»ä¼¼</p>
<h2 id="NSRecursiveLockï¼ˆé€’å½’é”ï¼‰">NSRecursiveLockï¼ˆé€’å½’é”ï¼‰</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å®ç°,</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)initialize &#123;</span><br><span class="line">  [<span class="built_in">NSLock</span> class];	<span class="comment">// Ensure mutex attributes are set up.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> != (<span class="keyword">self</span> = [<span class="keyword">super</span> init])) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">0</span> != pthread_mutex_init(&amp;_mutex, &amp;attr_recursive)) &#123;</span><br><span class="line">		  DESTROY(<span class="keyword">self</span>);	</span><br><span class="line">	   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒåœ¨ç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ˜¯<code>NSLock</code>ç±»çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–äº†ä¸‰ç§<code>attributes</code>, ç„¶ååœ¨<code>init</code>çš„æ—¶å€™ï¼Œåˆå§‹åŒ–äº†å±æ€§ä¸º<code>attr_recursive</code>çš„é”ï¼Œä¹Ÿå°±æ˜¯é€’å½’é”ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ”¯æŒé€’å½’å’Œå¾ªç¯, <code>NSRecursiveLock</code> ä¼šè®°å½•ä¸Šé”å’Œè§£é”çš„æ¬¡æ•°ï¼Œå½“äºŒè€…å¹³è¡¡çš„æ—¶å€™ï¼Œæ‰ä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹æ‰å¯ä»¥ä¸Šé”æˆåŠŸ, æ‰€ä»¥ä¸ä¼šé€ æˆæ­»é”.</p>
<p>å› ä¸ºå†…éƒ¨åˆ¤æ–­äº†é”çš„ç±»å‹ï¼Œæ‰€ä»¥æ€§èƒ½ä¼šæ¯”<code>pthread_mutex(recursive)</code> è¦ä½ä¸€äº›</p>
<h2 id="NSConditionLock_ï¼ˆæ¡ä»¶é”ï¼‰">NSConditionLock ï¼ˆæ¡ä»¶é”ï¼‰</h2><p>å…¶å®æ¡ä»¶é”ä¹Ÿæ˜¯ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå†…éƒ¨é€šè¿‡<code>NSCondition</code>æ¥å®ç°. <code>NSConditionLock</code>ä¼šæŒæœ‰ä¸€ä¸ª <code>NSCondition</code> å¯¹è±¡å’Œ <code>_condition_value</code> å±æ€§ï¼Œåœ¨åˆå§‹åŒ–æ—¶å°±ä¼šå¯¹è¿™ä¸ªå±æ€§è¿›è¡Œèµ‹å€¼ ,é»˜è®¤çš„<code>init</code>, <code>value</code>åˆ™ä¸º<code>0</code>, æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„æ–¹æ³•å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">self</span> initWithCondition: <span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithCondition:(<span class="built_in">NSInteger</span>)value &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">nil</span> != (<span class="keyword">self</span> = [<span class="keyword">super</span> init])) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="literal">nil</span> == (_condition = [<span class="built_in">NSCondition</span> new])) &#123;</span><br><span class="line">		  DESTROY(<span class="keyword">self</span>);</span><br><span class="line">	   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         _condition_value = value;</span><br><span class="line">		&#125;</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªå±æ€§ä¾¿æ˜¯<code>condition</code>,å¤–éƒ¨ä¼ å…¥çš„<code>condition</code>ä¸å†…éƒ¨ç›¸åŒæ‰ä¼šè·å–åˆ°<code>lock</code>å¯¹è±¡ï¼Œåä¹‹é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°<code>condition</code>ç›¸åŒ, è¿™å…¶å®æ˜¯ä¸€ä¸ªæ¶ˆè´¹è€…æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¶ˆè´¹è€…æ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)lockWhenCondition:(<span class="built_in">NSInteger</span>)value &#123;</span><br><span class="line">  [_condition lock];</span><br><span class="line">  <span class="keyword">while</span> (value != _condition_value) &#123;</span><br><span class="line">      [_condition wait];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿäº§è€…æ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)unlockWithCondition:(<span class="built_in">NSInteger</span>)value &#123;</span><br><span class="line">  _condition_value = value;</span><br><span class="line">  [_condition broadcast];</span><br><span class="line">  [_condition unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è§£é”çš„æ—¶å€™å¹¶ä¸æ˜¯<code>condition</code>ç›¸åŒæ‰èƒ½è§£é”, è€Œæ˜¯ç»™<code>_condition_value</code>èµ‹å€¼å¹¶é€šè¿‡<code>broadcast</code>æ–¹æ³•å”¤é†’åœ¨æ­¤<code>NSCondition</code>å¯¹è±¡ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹, æœ€åè§£é” </p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ä½¿ç”¨æ–¹æ³•:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">NSConditionLock</span> *lock = [[<span class="built_in">NSConditionLock</span> alloc] initWithCondition:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//çº¿ç¨‹1    </span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        [lock lockWhenCondition:<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"çº¿ç¨‹1"</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        [lock unlock];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//çº¿ç¨‹2   </span></span><br><span class="line"> <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        sleep(<span class="number">1</span>);<span class="comment">//ä»¥ä¿è¯è®©çº¿ç¨‹2çš„ä»£ç åæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> ([lock tryLockWhenCondition:<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"çº¿ç¨‹2"</span>);</span><br><span class="line">            [lock unlockWithCondition:<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"çº¿ç¨‹2è§£é”æˆåŠŸ"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//çº¿ç¨‹3</span></span><br><span class="line"> <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);<span class="comment">//ä»¥ä¿è¯è®©çº¿ç¨‹2çš„ä»£ç åæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> ([lock tryLockWhenCondition:<span class="number">2</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"çº¿ç¨‹3"</span>);</span><br><span class="line">            [lock unlock];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"çº¿ç¨‹3è§£é”æˆåŠŸ"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//çº¿ç¨‹4</span></span><br><span class="line"> <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        sleep(<span class="number">3</span>);<span class="comment">//ä»¥ä¿è¯è®©çº¿ç¨‹2çš„ä»£ç åæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> ([lock tryLockWhenCondition:<span class="number">2</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"çº¿ç¨‹4"</span>);</span><br><span class="line">            [lock unlockWithCondition:<span class="number">1</span>];    </span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"çº¿ç¨‹4è§£é”æˆåŠŸ"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line">è¾“å‡ºå¦‚ä¸‹:</span><br><span class="line"></span><br><span class="line">```objc</span><br><span class="line"><span class="number">2017</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">00</span>:<span class="number">01</span>:<span class="number">03.235</span> LuaTest[<span class="number">72076</span>:<span class="number">8074748</span>] çº¿ç¨‹<span class="number">2</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">00</span>:<span class="number">01</span>:<span class="number">03.236</span> LuaTest[<span class="number">72076</span>:<span class="number">8074748</span>] çº¿ç¨‹<span class="number">2</span>è§£é”æˆåŠŸ</span><br><span class="line"><span class="number">2017</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">00</span>:<span class="number">01</span>:<span class="number">04.232</span> LuaTest[<span class="number">72076</span>:<span class="number">8074747</span>] çº¿ç¨‹<span class="number">3</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">00</span>:<span class="number">01</span>:<span class="number">04.232</span> LuaTest[<span class="number">72076</span>:<span class="number">8074747</span>] çº¿ç¨‹<span class="number">3</span>è§£é”æˆåŠŸ</span><br><span class="line"><span class="number">2017</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">00</span>:<span class="number">01</span>:<span class="number">05.234</span> LuaTest[<span class="number">72076</span>:<span class="number">8074770</span>] çº¿ç¨‹<span class="number">4</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">00</span>:<span class="number">01</span>:<span class="number">05.235</span> LuaTest[<span class="number">72076</span>:<span class="number">8074770</span>] çº¿ç¨‹<span class="number">4</span>è§£é”æˆåŠŸ</span><br><span class="line"><span class="number">2017</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">00</span>:<span class="number">01</span>:<span class="number">05.235</span> LuaTest[<span class="number">72076</span>:<span class="number">8074767</span>] çº¿ç¨‹<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç å…ˆè¾“å‡ºäº† <code>çº¿ç¨‹ 2</code>ï¼Œå› ä¸º<code>çº¿ç¨‹ 1</code> çš„åŠ é”æ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆå§‹åŒ–æ—¶å€™çš„ <code>condition</code> å‚æ•°ä¸º 0ï¼Œè€ŒåŠ é”æ¡ä»¶æ˜¯ <code>condition</code> ä¸º 1ï¼Œæ‰€ä»¥åŠ é”å¤±è´¥ã€‚<code>locakWhenCondition</code> ä¸ lock æ–¹æ³•ç±»ä¼¼ï¼ŒåŠ é”å¤±è´¥ä¼šé˜»å¡çº¿ç¨‹ï¼Œæ‰€ä»¥<code>çº¿ç¨‹ 1</code> ä¼šè¢«é˜»å¡ç€ï¼Œè€Œ <code>tryLockWhenCondition</code> æ–¹æ³•å°±ç®—æ¡ä»¶ä¸æ»¡è¶³ï¼Œä¹Ÿä¼šè¿”å› NOï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚å›åˆ°ä¸Šé¢çš„ä»£ç ï¼Œ<code>çº¿ç¨‹ 2</code> æ‰§è¡Œäº† <code>[lock unlockWithCondition:2]</code> æ‰€ä»¥ <code>Condition</code> è¢«ä¿®æ”¹æˆäº† <code>2</code>ã€‚è€Œ<code>çº¿ç¨‹ 3</code> çš„åŠ é”æ¡ä»¶æ˜¯ <code>Condition</code> ä¸º <code>2</code>ï¼Œ æ‰€ä»¥<code>çº¿ç¨‹ 3</code> æ‰èƒ½åŠ é”æˆåŠŸï¼Œ<code>çº¿ç¨‹ 3</code> æ‰§è¡Œäº† <code>[lock unlock]</code>; è§£é”æˆåŠŸä¸”ä¸æ”¹å˜ <code>Condition</code> å€¼ã€‚<code>çº¿ç¨‹ 4</code> çš„æ¡ä»¶ä¹Ÿæ˜¯ <code>2</code>ï¼Œæ‰€ä»¥ä¹ŸåŠ é”æˆåŠŸï¼Œè§£é”æ—¶å°† <code>Condition</code> æ”¹æˆ <code>1</code>ã€‚è¿™ä¸ªæ—¶å€™<code>çº¿ç¨‹ 1</code> ç»ˆäºå¯ä»¥åŠ é”æˆåŠŸï¼Œè§£é™¤äº†é˜»å¡ã€‚ å‡å¦‚<code>çº¿ç¨‹4``unlockWithCondition</code>è§£é”æ¡ä»¶ä¸º<code>é1</code>, å†…éƒ¨<code>conditon</code>å€¼ä¸ä¸€è‡´, é‚£ä¹ˆ<code>çº¿ç¨‹1</code>å°†ä¼šæ°¸ä¹…é˜»å¡.</p>
<p>ä»ä¸Šé¢å¯ä»¥å¾—å‡ºï¼ŒNSConditionLock è¿˜å¯ä»¥å®ç°ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–ã€‚</p>
<h2 id="@Synchronized">@Synchronized</h2><p>å…ˆæ¥çœ‹ä¸‹ç”¨æ³•ï¼Œ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@synchronized</span> (obj) &#123;</span><br><span class="line">	<span class="comment">// do something            </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯åªéœ€è¦ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå°±å¯ä»¥ä½¿ä»£ç å—å®ç°åŒæ­¥</p>
<p>æˆ‘ä»¬åœ¨<code>Xcode</code>ä¸­é€‰æ‹©<code>Product -&gt; Perform Action -&gt; Assemble &#39;main.m&#39;</code>, æˆ‘ä»¬ä¾¿èƒ½çœ‹åˆ°æ±‡ç¼–ä»£ç â€¦</p>
<p><img src="http://7xoijj.com1.z0.glb.clouddn.com/5AEA053C-6EED-41CE-A29B-69EB444F2E9D.png" alt=""></p>
<p>æˆ‘ä»¬ä¼šå‘ç°ä¸¤ä¸ªæ¯”è¾ƒé™Œç”Ÿçš„æ–¹æ³•è°ƒç”¨ <code>_objc_sync_enter</code>å’Œ <code>_objc_sync_exit</code>  emmmmmm ï¼Ÿ </p>
<p>â€¦ æˆ‘ä»¬åªè°ƒç”¨äº†<code>synchronized</code>â€¦ è«éå°±æ˜¯è¿™ä¸ªå‡½æ•°çš„åº•å±‚å®ç°ï¼Ÿ æˆ‘ä»¬åˆ°<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objcæºç æ‰¾æ‰¾</a>, åœ¨<code>objc-sync.mm</code>ä¸­æ‰¾åˆ°äº†è¿™ä¸¤ä¸ªå‡½æ•°çš„å®ç°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Begin synchronizing on 'obj'. </span></span><br><span class="line"><span class="comment">// Allocates recursive mutex associated with 'obj' if needed.</span></span><br><span class="line"><span class="comment">// Returns OBJC_SYNC_SUCCESS once lock is acquired.  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> objc_sync_enter(<span class="keyword">id</span> obj) &#123;</span><br><span class="line">    <span class="keyword">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        SyncData *data = id2data(obj, ACQ<span class="built_in">UIRE</span>);</span><br><span class="line">        data-&gt;mutex<span class="variable">.lock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// @synchronized(nil) does nothing</span></span><br><span class="line">        objc_sync_nil();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•çš„æ³¨é‡Šå·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œè¿™ä¸ªæ–¹æ³•çš„å®ç°ç”¨çš„æ˜¯é€’å½’é”ï¼Œé¦–å…ˆåˆ¤æ–­<code>obj</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™é€šè¿‡<code>obj</code>åˆ›å»ºä¸€ä¸ª<code>SyncData</code>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨<code>lock</code>ï¼Œå¦åˆ™åˆ™ç›´æ¥è°ƒç”¨<code>objc_sync_nil ()</code>æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œå•¥éƒ½æ²¡å¹²,ä¹Ÿå°±æ˜¯è¯´å¦‚æœç›´æ¥è°ƒç”¨<code>@synchronized(nil)</code>çš„è¯ï¼Œå…¶å®ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œä¹Ÿä¸ä¼šåˆ›å»ºé”.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> SyncData &#123;</span><br><span class="line">    <span class="keyword">struct</span> SyncData* nextData;</span><br><span class="line">    DisguisedPtr&lt;objc_object&gt; object;</span><br><span class="line">    int32_t threadCount;  <span class="comment">// number of THREADS using this block</span></span><br><span class="line">    recursive_mutex_t mutex;</span><br><span class="line">&#125; SyncData;</span><br></pre></td></tr></table></figure>
<p><code>SyncData</code>åŒ…æ‹¬<code>nextData</code>ã€<code>object</code>ã€<code>threadCount (çº¿ç¨‹æ•°)</code>ã€<code>mutex (é€’å½’é”)</code></p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹æ–¹æ³•æ˜¯å¦‚ä½•é€šè¿‡<code>obj</code>è·å–åˆ°<code>data</code>çš„ï¼Œ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">  Fast cache: two fixed pthread keys store a single SyncCacheItem. </span><br><span class="line">  This avoids malloc of the SyncCache for threads that only synchronize </span><br><span class="line">  a single object at a time.</span><br><span class="line">  SYNC_DATA_DIRECT_KEY  == SyncCacheItem.data</span><br><span class="line">  SYNC_COUNT_DIRECT_KEY == SyncCacheItem.lockCount</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> SyncList &#123;</span><br><span class="line">    SyncData *data;</span><br><span class="line">    spinlock_t lock;</span><br><span class="line">    SyncList() : data(<span class="literal">nil</span>), lock(fork_unsafe_lock) &#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use multiple parallel lists to decrease contention among unrelated objects.</span></span><br><span class="line"><span class="preprocessor">#define LOCK_FOR_OBJ(obj) sDataLists[obj].lock</span></span><br><span class="line"><span class="preprocessor">#define LIST_FOR_OBJ(obj) sDataLists[obj].data</span></span><br><span class="line"><span class="keyword">static</span> StripedMap&lt;SyncList&gt; sDataLists;</span><br></pre></td></tr></table></figure>
<p>å‘ç°å®šä¹‰äº†<code>sDataLists</code>ï¼Œä¸€ä¸ª<code>SyncList</code> ç»“æ„ä½“æ•°ç»„,</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> indexForPointer(<span class="keyword">const</span> <span class="keyword">void</span> *p) &#123;</span><br><span class="line">    uintptr_t addr = reinterpret_cast&lt;uintptr_t&gt;(p);</span><br><span class="line">    <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">T&amp; operator[] (<span class="keyword">const</span> <span class="keyword">void</span> *p) &#123; </span><br><span class="line">   <span class="keyword">return</span> array[indexForPointer(p)]<span class="variable">.value</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å“ˆå¸Œç®—æ³•å°†ä¼ å…¥<code>obj</code>æ˜ å°„åˆ°æ•°ç»„ä¸Šçš„ä¸€ä¸ªä¸‹æ ‡, æ˜¯å°†å¯¹è±¡æŒ‡é’ˆåœ¨å†…å­˜çš„åœ°å€,æ˜ å°„åˆ°å¦ä¸€ä¸ªå†…å­˜ç©ºé—´æ¥å­˜æ”¾<code>SyncList</code>,è¿™æ ·èƒ½å¤Ÿä¿è¯ä¸ä¼šå‘ç”Ÿæ•°ç»„è¶Šç•Œï¼Œå½“è°ƒç”¨<code>objc_sync_enter</code>æ—¶ï¼Œé€šè¿‡<code>obj</code>å†…å­˜åœ°å€çš„å“ˆå¸Œå€¼æ‰¾åˆ° <code>SyncData</code>,å¹¶è°ƒç”¨<code>lock</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// End synchronizing on 'obj'. </span></span><br><span class="line"><span class="comment">// Returns OBJC_SYNC_SUCCESS or OBJC_SYNC_NOT_OWNING_THREAD_ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> objc_sync_exit(<span class="keyword">id</span> obj) &#123;</span><br><span class="line">    <span class="keyword">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        SyncData* data = id2data(obj, RELEASE); </span><br><span class="line">        <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">bool</span> okay = data-&gt;mutex<span class="variable">.tryUnlock</span>();</span><br><span class="line">            <span class="keyword">if</span> (!okay) &#123;</span><br><span class="line">                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// @synchronized(nil) does nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>objc_sync_exit</code>æ–¹æ³•ä¹Ÿå·®ä¸å¤šï¼Œé€šè¿‡<code>obj</code>å†…å­˜åœ°å€çš„å“ˆå¸Œå€¼æ‰¾åˆ° <code>SyncData</code>,å¹¶è°ƒç”¨<code>tryUnlock</code>,å¦‚æœè¿”å›true,åˆ™è¡¨ç¤ºè§£é”æˆåŠŸï¼Œå¦åˆ™æ˜¯å¤±è´¥</p>
<h2 id="NSDistributedLock_(åˆ†å¸ƒå¼é”)">NSDistributedLock (åˆ†å¸ƒå¼é”)</h2><p><code>NSDistributedLock</code>ä¸å…¶ä»–é”ä¸å¤ªä¸€æ ·, å®ƒæ²¡æœ‰å®ç°<code>NSLocking</code>åè®®, å®ƒåº•å±‚æ˜¯åŸºäºæ–‡ä»¶ç³»ç»Ÿå®ç°çš„äº’æ–¥é”ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºç”¨äºæ ‡è¯†çš„ä¸´æ—¶æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œå®Œåè‡ªåŠ¨æ¸…é™¤ä¸´æ—¶æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼›å¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹æˆ–å¤šä¸ªç¨‹åºä¹‹é—´éœ€è¦æ„å»ºäº’æ–¥çš„åœºæ™¯ä¸­ä½¿ç”¨</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)initialize &#123;</span><br><span class="line">  <span class="keyword">if</span> (mgr == <span class="literal">nil</span>) &#123;</span><br><span class="line">      mgr = RETAIN([<span class="built_in">NSFileManager</span> defaultManager]);</span><br><span class="line">      [[<span class="built_in">NSObject</span> leakAt: &amp;mgr] release];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithPath:(<span class="built_in">NSString</span>*)aPath &#123;</span><br><span class="line">  <span class="built_in">NSString</span>	*lockDir;</span><br><span class="line">  <span class="built_in">BOOL</span>		isDirectory;</span><br><span class="line"></span><br><span class="line">  _lockPath = [[aPath stringByStandardizingPath] <span class="keyword">copy</span>];</span><br><span class="line">  _lockTime = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">  lockDir = [_lockPath stringByDeletingLastPathComponent];</span><br><span class="line">  <span class="keyword">if</span> ([mgr fileExistsAtPath: lockDir isDirectory: &amp;isDirectory] == <span class="literal">NO</span>) &#123;</span><br><span class="line">      DESTROY(<span class="keyword">self</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  &#125;   </span><br><span class="line">  <span class="keyword">if</span> (isDirectory == <span class="literal">NO</span>) &#123;</span><br><span class="line">      DESTROY(<span class="keyword">self</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ([mgr isWritableFileAtPath: lockDir] == <span class="literal">NO</span>) &#123;</span><br><span class="line">      DESTROY(<span class="keyword">self</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ([mgr isExecutableFileAtPath: lockDir] == <span class="literal">NO</span>) &#123;</span><br><span class="line">      DESTROY(<span class="keyword">self</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä»å®ƒçš„åˆå§‹åŒ–æ–¹æ³•ä¾¿èƒ½å¤Ÿçœ‹å‡ºå†…éƒ¨æ˜¯åŸºäº<code>NSFileManager</code>æ–‡ä»¶ç³»ç»Ÿå®ç°çš„ï¼Œç”±äºå…¶æ²¡æœ‰å®ç°<code>NSLocking</code>åè®®ï¼Œæ‰€ä»¥æ²¡æœ‰ä¼šé˜»å¡çº¿ç¨‹çš„<code>lock</code>æ–¹æ³•ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯éé˜»å¡çš„<code>tryLock</code>æ–¹æ³•, <code>NSDistributedLock</code>åªæœ‰åœ¨é”æŒæœ‰è€…æ˜¾å¼åœ°é‡Šæ”¾åæ‰ä¼šè¢«é‡Šæ”¾. å¦‚æœä½ çš„ç¨‹åºåœ¨ä¸€ä¸ª<code>NSDistributedLock</code>çš„æ—¶å€™å´©æºƒäº†ï¼Œå…¶ä»–å®¢æˆ·ç«¯æ— æ³•è®¿é—®è¯¥å—ä¿æŠ¤çš„èµ„æºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>breadLock</code>æ–¹æ³•æ¥æ‰“ç ´ç°å­˜çš„é”ä»¥ä¾¿ä½ å¯ä»¥è·å–å®ƒ, ä½†æ˜¯é€šå¸¸åº”è¯¥é¿å…æ‰“ç ´é”ï¼Œé™¤éä½ ç¡®å®šæ‹¥æœ‰è¿›ç¨‹å·²ç»æ­»äº¡å¹¶ä¸å¯èƒ½å†é‡Šæ”¾è¯¥é”. å’Œå…¶ä»–ç±»å‹çš„é”ä¸€æ ·ï¼Œå½“ä½ ä½¿ç”¨<code>NSDistributedLock</code>å¯¹è±¡æ—¶ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨<code>unlock</code>æ–¹æ³•æ¥é‡Šæ”¾å®ƒ</p>
<h3 id="PSï¼šèŠ±äº†å¿«ä¸€æ˜ŸæœŸé›¶é›¶ç¢ç¢çš„æ—¶é—´ï¼Œç ”ç©¶äº†ä¸€ä¸‹è¿™äº›ğŸ”ï¼Œå‘ç°æ”¶è´§è‰¯å¤šï¼Œä»ğŸ”çš„ä½¿ç”¨åˆ°å®ç°éƒ½æœ‰äº†æ›´è¿›ä¸€æ­¥çš„è®¤è¯†-ä»¥åŠå¯¹é”çš„æ€§èƒ½ä¹Ÿæœ‰äº†è¿›ä¸€æ­¥çš„ç†è§£-">PSï¼šèŠ±äº†å¿«ä¸€æ˜ŸæœŸé›¶é›¶ç¢ç¢çš„æ—¶é—´ï¼Œç ”ç©¶äº†ä¸€ä¸‹è¿™äº›ğŸ”ï¼Œå‘ç°æ”¶è´§è‰¯å¤šï¼Œä»ğŸ”çš„ä½¿ç”¨åˆ°å®ç°éƒ½æœ‰äº†æ›´è¿›ä¸€æ­¥çš„è®¤è¯†.ä»¥åŠå¯¹é”çš„æ€§èƒ½ä¹Ÿæœ‰äº†è¿›ä¸€æ­¥çš„ç†è§£.</h3>
      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/09/25/å¼ºå¤§çš„Fishhook/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">å¼ºå¤§çš„Fishhook</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">åˆ†äº«åˆ°ï¼š</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- å¤šè¯´è¯„è®ºæ¡† start -->
	<div class="ds-thread" data-thread-key="æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰" data-title="æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰" data-url="http://yoursite.com/2017/09/29/æ·±å…¥ç†è§£iOSå„ç§é”ï¼ˆğŸ”ï¼‰/"></div>
	<!-- å¤šè¯´è¯„è®ºæ¡† end -->
	<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"aeronxie"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Aeron_Xie
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>